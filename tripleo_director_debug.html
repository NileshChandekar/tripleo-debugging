<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Tripleo/Director Debugging</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Tripleo/Director Debugging</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_undercloud">Undercloud</a>
<ul class="sectlevel2">
<li><a href="#_undercloud_install_recommendations">Undercloud install Recommendations</a></li>
<li><a href="#_undercloud_install_debug">Undercloud install Debug</a></li>
<li><a href="#_enrolling_overcloud">Enrolling overcloud</a></li>
</ul>
</li>
<li><a href="#_introspection">Introspection</a>
<ul class="sectlevel2">
<li><a href="#_introspection_recomendations">Introspection Recomendations</a></li>
<li><a href="#_introspection_debug">Introspection Debug</a></li>
</ul>
</li>
<li><a href="#_deploy_provsion_phase">Deploy/Provsion phase</a>
<ul class="sectlevel2">
<li><a href="#_deploy_phase_recommendations">Deploy phase recommendations</a></li>
<li><a href="#_deploy_phase_debug">Deploy phase Debug</a></li>
</ul>
</li>
<li><a href="#_overcloud_deploy">Overcloud Deploy</a>
<ul class="sectlevel2">
<li><a href="#_overcloud_templates">Overcloud templates</a></li>
<li><a href="#_mistral_plans_debug">Mistral Plans Debug</a></li>
<li><a href="#_overcloud_deploy_debug">Overcloud Deploy Debug</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_undercloud">Undercloud</h2>
<div class="sectionbody">
<hr>
<div class="sect2">
<h3 id="_undercloud_install_recommendations">Undercloud install Recommendations</h3>
<div class="paragraph">
<p><strong>Undercloud recommended specs</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>CPUs:  2x Physical cores, 24 threads</p>
</li>
<li>
<p>Disk: (single ssd or 2x drives 7200RPM) Root disk / raid1 Disk for swift</p>
</li>
<li>
<p>Memory:  64G</p>
</li>
<li>
<p>Network : 10G for provisioning</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>undercloud.conf recommended options</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>undercloud_debug = false  --&gt;  only enable debug if needed
enable_telemetry = false  --&gt;  disable telemetry
automated_clean = true    --&gt; (is osp11 as clean_nodes=true) runs wipefs --force --all before making node available</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Undercloud tunning</strong></p>
</div>
<div class="paragraph">
<p>Keystone worker counts: increase the worker count to available cpus/2 if you have enough ram</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# cat /etc/httpd/conf.d/10-keystone_wsgi_admin.conf | grep processes
  WSGIDaemonProcess keystone_admin display-name=keystone-admin group=keystone processes=4 threads=2 user=keystone
[root@undercloud ~]# cat /etc/httpd/conf.d/10-keystone_wsgi_main.conf  | grep processes
  WSGIDaemonProcess keystone_main display-name=keystone-main group=keystone processes=4 threads=2 user=keystone</pre>
</div>
</div>
<div class="paragraph">
<p>Heat RPC response timeout, increase to 600 to be on the safe side</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# cat /etc/heat/heat.conf | grep ^rpc_response_timeout
rpc_response_timeout = 600</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_undercloud_install_debug">Undercloud install Debug</h3>
<div class="paragraph">
<p>TODO!!</p>
</div>
</div>
<div class="sect2">
<h3 id="_enrolling_overcloud">Enrolling overcloud</h3>
<div class="paragraph">
<p>When enrolling overcloud nodes with the import command, the ironic driver tests the connectivity with the Ilo/drac</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[stack@undercloud ~]$ openstack baremetal import --json ~/instackenv.json</pre>
</div>
</div>
<div class="paragraph">
<p>If the command takes a long time to finish and the nodes are in enroll state</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud conf.d]$ openstack baremetal list
This command is deprecated. Instead, use 'openstack baremetal node list'.
+--------------------------------------+------+---------------+-------------+--------------------+-------------+
| UUID                                 | Name | Instance UUID | Power State | Provisioning State | Maintenance |
+--------------------------------------+------+---------------+-------------+--------------------+-------------+
| 149a4a65-739c-4599-823c-cf0c6dbcd37c | None | None          | None        | enroll             | False       |
| 82079e5a-b02e-443c-bf6b-51b4cb6b149f | None | None          | None        | enroll             | False       |
| ac0b308f-15bd-43f2-8aaa-fc9c872c0343 | None | None          | None        | enroll             | False       |
| 6a05da8a-5963-4a19-a419-e71ef684e3e9 | None | None          | None        | enroll             | False       |
+--------------------------------------+------+---------------+-------------+--------------------+-------------+</pre>
</div>
</div>
<div class="paragraph">
<p>Check the ironic-conductor.log for problems comunicating the IPMI/ilo/drac BMC platforms:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> 2017-06-11 10:27:14.977 10009 ERROR ironic.conductor.manager [req-afc9a72c-58bf-4fd0-a23d-d8d43905bbde - - - - -] Failed to validate power driver interface for node 149a4a65-739c-4599-823c-cf0c6dbcd37c. Error: SSH connection cannot be established: Failed to establish SSH connection to host 192.168.101.1.
2017-06-11 10:27:14.984 10009 ERROR ironic.conductor.manager [req-f614ec7f-e7f0-4231-97b7-65ee3f248110 - - - - -] Failed to validate power driver interface for node 6a05da8a-5963-4a19-a419-e71ef684e3e9. Error: SSH connection cannot be established: Failed to establish SSH connection to host 192.168.101.1.
2017-06-11 10:27:15.227 10009 ERROR ironic.conductor.manager [req-bde5bf5c-e89b-4cc5-89f8-c857f8392e41 - - - - -] Failed to validate power driver interface for node ac0b308f-15bd-43f2-8aaa-fc9c872c0343. Error: SSH connection cannot be established: Failed to establish SSH connection to host 192.168.101.1.
2017-06-11 10:27:15.232 10009 ERROR ironic.conductor.manager [req-987d2ef5-129d-401d-9c8c-ff3a856b9fb1 - - - - -] Failed to validate power driver interface for node 82079e5a-b02e-443c-bf6b-51b4cb6b149f. Error: SSH connection cannot be established: Failed to establish SSH connection to host 192.168.101.1.</pre>
</div>
</div>
<div class="paragraph">
<p>Fix the problem with the BMC connection, and rerun the baremetal import command again</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introspection">Introspection</h2>
<div class="sectionbody">
<hr>
<div class="sect2">
<h3 id="_introspection_recomendations">Introspection Recomendations</h3>
<div class="ulist">
<ul>
<li>
<p>Try small instrospection bundles first.</p>
</li>
<li>
<p>Do not introspect more nodes than your DHCP range allows.</p>
</li>
<li>
<p>After introspection, wait for about two minutes to let DHCP leases to expire.</p>
</li>
<li>
<p>Watch for any additional DHCP servers on the provisioning network</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_introspection_debug">Introspection Debug</h3>
<div class="paragraph">
<p><strong>Logs</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ironic]# ls -l /var/log/ironic-inspector/*.log
-rw-r--r--. 1 ironic-inspector ironic-inspector 32080 Jun  1 10:37 /var/log/ironic-inspector/ironic-inspector.log
[root@undercloud ironic]# ls -l /var/log/ironic/*.log
-rw-r--r--. 1 ironic ironic 2238295 Jun  3 08:26 /var/log/ironic/ironic-api.log
-rw-r--r--. 1 ironic ironic  235499 Jun  2 07:54 /var/log/ironic/ironic-conductor.log
root@undercloud ~]# journalctl -u openstack-ironic-inspector -u openstack-ironic-inspector-dnsmasq
Jun 07 09:07:57 undercloud.localdomain ironic-inspector[1236]: 2017-06-07 09:07:57.353 1236 INFO ironic_inspector.node_cache [-] [node: ba4db2bf-c327-4fca-a37e-83cc17c1561a state processing] Updating node state: processing --&gt; finished
Jun 07 09:07:57 undercloud.localdomain ironic-inspector[1236]: 2017-06-07 09:07:57.347 1236 INFO ironic_inspector.process [-] [node: ba4db2bf-c327-4fca-a37e-83cc17c1561a MAC aa:bb:cc:dd:ee:02] Introspection finished successfully
Jun 07 09:07:57 undercloud.localdomain ironic-inspector[1236]: 2017-06-07 09:07:57.315 1236 INFO ironic_inspector.process [-] [node: ba4db2bf-c327-4fca-a37e-83cc17c1561a MAC aa:bb:cc:dd:ee:02] Node powered-off</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Accessing logs from the ram disk run</strong></p>
</div>
<div class="paragraph">
<p>If something fails during the introspection ramdisk run, ironic-inspector stores the ramdisk logs in /var/log/ironic-inspector/ramdisk/ as gz-compressed tar files. File names contain date, time and IPMI address of the node if it was detected (only for bare metal).</p>
</div>
<div class="paragraph">
<p>If you want to inspect the ram disk run even if it didn&#8217;t fail we have to modify the always_store_ramdisk_logs option in  /etc/ironic-inspector/inspector.conf and restart the service</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# sed -ibck 's/^.*always_store_ramdisk_logs.*$/always_store_ramdisk_logs = true/g' /etc/ironic-inspector/inspector.conf
[root@undercloud ~]#  openstack baremetal introspection start ba4db2bf-c327-4fca-a37e-83cc17c1561a
[root@undercloud ~]# systemctl restart openstack-ironic-inspector.service
[root@undercloud ~]# ls -l /var/log/ironic-inspector/ramdisk/
total 20
-rw-r--r--. 1 ironic-inspector ironic-inspector 16820 Jun  7 09:16 ba4db2bf-c327-4fca-a37e-83cc17c1561a_20170607-131619.504127.tar.gz</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Log into the ramdisk for debugging via ssh/console</strong></p>
</div>
<div class="paragraph">
<p>Use ssl to create a hash for a password</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# openssl passwd -1
Password:
Verifying - Password:
$1$ZqPeffYv$CvGO/oS8b28YRdMMS2WCF1</pre>
</div>
</div>
<div class="paragraph">
<p>Edit /httpboot/inspector.ipxe manually. Find the line starting with “kernel” and append rootpwd=”HASH” to it, also disable selinux with the selinux=0 option</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# cat /httpboot/inspector.ipxe
#!ipxe

:retry_boot
imgfree
kernel --timeout 60000 http://10.0.0.10:8088/agent.kernel ipa-inspection-callback-url=http://10.0.0.10:5050/v1/continue ipa-inspection-collectors=default,extra-hardware,logs systemd.journald.forward_to_console=yes BOOTIF=${mac} ipa-inspection-dhcp-all-interfaces=1 ipa-collect-lldp=1 initrd=agent.ramdisk rootpwd="$1$UQ/HlKRP$pXaAJKgSS7z7SPqOTH0FV/" selinux=0 || goto retry_boot
initrd --timeout 60000 http://10.0.0.10:8088/agent.ramdisk || goto retry_boot
boot</pre>
</div>
</div>
<div class="paragraph">
<p>We can see the options we added to the cmdline being lodaded on the next ram disk run</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ramdisk/journal:Jun 07 09:14:38 localhost.localdomain kernel: Command line: ipa-inspection-callback-url=http://10.0.0.10:5050/v1/continue ipa-inspection-collectors=default,extra-hardware,logs systemd.journald.forward_to_console=yes BOOTIF=aa:bb:cc:dd:ee:02 ipa-inspection-dhcp-all-interfaces=1 ipa-collect-lldp=1 initrd=agent.ramdisk rootpwd="$1$UQ/HlKRP$pXaAJKgSS7z7SPqOTH0FV/" selinux=0</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Modify ramdisk image</strong></p>
</div>
<div class="paragraph">
<p>If you need to modify the ramdisk image to fix some issue you can follow these steps:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud httpboot]# cp /httpboot/agent.ramdisk /root/agent.ramdisk
[root@undercloud ~]# mkdir agent.ramdisk.dir
[root@undercloud ~]# cd agent.ramdisk.dir
[root@undercloud agent.ramdisk.dir]# gzip -dc ../agent.ramdisk | cpio --extract
1872427 blocks
[root@undercloud agent.ramdisk.dir]# ls
bin  boot  dev  etc  home  init  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</pre>
</div>
</div>
<div class="paragraph">
<p>After modifiying the image, we zip it again and move it into the httpboot dir</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud httpboot]# find . | cpio -oc | gzip -c -9&gt;| ~/agent.ramdisk.root-test
[root@undercloud httpboot]# cp ~/agent.ramdisk.root-test /httpboot/agent.ramdisk</pre>
</div>
</div>
<div class="paragraph">
<p>Check selinux permissions are ok:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[root@undercloud httpboot]#chcon system_u:object_r:httpd_user_content_t:s0 agent.ramdisk</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Check the Ironic driver you are using is enabled and available</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# openstack baremetal driver list
+---------------------+------------------------+
| Supported driver(s) | Active host(s)         |
+---------------------+------------------------+
| ipmi                | undercloud.localdomain |
| pxe_drac            | undercloud.localdomain |
| pxe_ilo             | undercloud.localdomain |
| pxe_ipmitool        | undercloud.localdomain |
| pxe_ssh             | undercloud.localdomain |
+---------------------+------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p><strong>If you have power on/power off timeout problems in Ironic(<a href="https://access.redhat.com/solutions/2332151" class="bare">https://access.redhat.com/solutions/2332151</a>), increase the power_retry and power_wait parameters</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre># Options defined in ironic.drivers.modules.ilo.power
#

# Number of times a power operation needs to be retried
# (integer value)
power_retry=6

# Amount of time in seconds to wait in between power
# operations (integer value)
power_wait=20</pre>
</div>
</div>
<div class="paragraph">
<p><strong>If using IPMI driver, and errors are seen check:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ipmitool is installed.</p>
</li>
<li>
<p>The IPMI controller on your bare metal server is turned on.</p>
</li>
<li>
<p>The IPMI controller credentials passed in the command are right.</p>
</li>
<li>
<p>The conductor node has a route to the IPMI controller. This can be checked by just pinging the IPMI controller IP from the conductor node.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also test that you can access the status of the BMC using the ipmitool command several times</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ipmitool -I lanplus -H &lt;ip-address&gt; -U &lt;username&gt; -P &lt;password&gt; chassis power status</pre>
</div>
</div>
<div class="paragraph">
<p><strong>slow or unresponsive BMCs in the environment</strong></p>
</div>
<div class="paragraph">
<p>the retry_timeout configuration option in the [ipmi] section may need to be increased. The default is fairly conservative, as setting this timeout too low can cause older BMCs to crash and require a hard-reset.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# more /etc/ironic/ironic.conf | grep ^retry_timeout
retry_timeout = 15</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Check Bios config "Legacy" or "UEFI"</strong></p>
</div>
<div class="paragraph">
<p>Out-of-the-box install of Red Hat OpenStack Platform 10 sets ironic.conf on the undercloud in default_boot_mode = bios</p>
</div>
<div class="paragraph">
<p>The default state of the ironic.conf file on the undercloud is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>default_boot_mode = bios</pre>
</div>
</div>
<div class="paragraph">
<p>If uefi boot is needed in introspection and deploy, change it to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>default_boot_mode = uefi</pre>
</div>
</div>
<div class="paragraph">
<p><strong>DHCP info and debug for introspection</strong></p>
</div>
<div class="paragraph">
<p>The introspection dhcp service uses dnsmasq:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# ps -ef | grep -i ironic-inspector | grep dns
nobody    1310     1  0 Jun01 ?        00:00:00 /sbin/dnsmasq --conf-file=/etc/ironic-inspector/dnsmasq.conf</pre>
</div>
</div>
<div class="paragraph">
<p>The conf file is in /etc/ironic-inspector/dnsmasq.conf, you can check interface and dhcp-range:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ~]# cat /etc/ironic-inspector/dnsmasq.conf
port=0
interface=br-ctlplane
bind-interfaces
dhcp-range=10.0.0.100,10.0.0.120,29
dhcp-sequential-ip
dhcp-match=ipxe,175
dhcp-match=set:efi,option:client-arch,7
# Client is running iPXE; move to next stage of chainloading
dhcp-boot=tag:ipxe,http://10.0.0.10:8088/inspector.ipxe
# Client is running PXE over EFI; send EFI version of iPXE chainloader
dhcp-boot=tag:efi,ipxe.efi
# Client is running PXE over BIOS; send BIOS version of iPXE chainloader
dhcp-boot=undionly.kpxe,localhost.localdomain,10.0.0.10</pre>
</div>
</div>
<div class="paragraph">
<p>Use tcpdump on the provisioning interface:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[root@undercloud ~]# tcpdump -i &lt;network-interface&gt; port 67 or port 68 or port 69 -e -n</pre>
</div>
</div>
<div class="paragraph">
<p>Filter matching the client Mac address:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>tcpdump -i br0 -vvv -s 1500 '((port 67 or port 68) and (udp[38:4] = 0x3e0ccf08))'</pre>
</div>
</div>
<div class="paragraph">
<p>Tcpdump filter to capture packets sent by the client (DISCOVER, REQUEST, INFORM):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>tcpdump -i br0 -vvv -s 1500 '((port 67 or port 68) and (udp[8:1] = 0x1))'</pre>
</div>
</div>
<div class="paragraph">
<p><strong>If the Dhcp client isn&#8217;t able to comunicate with the Dhcp server</strong></p>
</div>
<div class="paragraph">
<p>Check that the client Mac is getting whitelisted in Iptables, We can look for the the mac address of the overcloud node that we are going to introspect, in this case the node uid is <strong>50fd27b6-7af7-425e-94b2-f6fb0f9f5bfa</strong> with mac <strong>aa:bb:cc:dd:ee:01</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ~]# openstack baremetal port list
+--------------------------------------+-------------------+
| UUID                                 | Address           |
+--------------------------------------+-------------------+
| 5da9df9d-adea-4d89-ade2-f083478cdfbf | aa:bb:cc:dd:ee:01 |
| 3a2687cf-318b-4c80-bc18-01c20b49ed29 | aa:bb:cc:dd:ee:02 |
| 04cf3e6a-c27f-4ce4-9719-93dfe82e48db | aa:bb:cc:dd:ee:03 |
| 24b39ae8-1009-4d21-9269-683f010790bf | aa:bb:cc:dd:ee:04 |
+--------------------------------------+-------------------+
[root@undercloud ~]# openstack baremetal port show 5da9df9d-adea-4d89-ade2-f083478cdfbf
+------------+--------------------------------------+
| Field      | Value                                |
+------------+--------------------------------------+
| address    | aa:bb:cc:dd:ee:01                    |
| created_at | 2017-06-01T13:57:08+00:00            |
| extra      | {}                                   |
| node_uuid  | 50fd27b6-7af7-425e-94b2-f6fb0f9f5bfa |
| updated_at | 2017-06-02T11:53:59+00:00            |
| uuid       | 5da9df9d-adea-4d89-ade2-f083478cdfbf |
+------------+--------------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>We now are going to run the introspection on that node and check the iptable rules, our mac is going to get white listed and removed from the macs with the DROP target</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ~]# iptables -nL | grep -A 2 "Chain ironic-inspector"
Chain ironic-inspector (1 references)
target     prot opt source               destination
REJECT     all  --  0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
[root@undercloud ~]# openstack  baremetal introspection start 50fd27b6-7af7-425e-94b2-f6fb0f9f5bfa
[root@undercloud ~]# iptables -nL | grep -B 2 -A 2 -i AA:BB
Chain ironic-inspector (1 references)
target     prot opt source               destination
DROP       all  --  0.0.0.0/0            0.0.0.0/0            MAC AA:BB:CC:DD:EE:04
DROP       all  --  0.0.0.0/0            0.0.0.0/0            MAC AA:BB:CC:DD:EE:03
DROP       all  --  0.0.0.0/0            0.0.0.0/0            MAC AA:BB:CC:DD:EE:02
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0</pre>
</div>
</div>
<div class="paragraph">
<p>We can also check in the logs the same process in the introspection logs</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ironic-inspector]# grep -i 'aa:bb:cc:dd:ee:01' ironic-inspector.log
2017-06-07 16:48:49.196 7354 INFO ironic_inspector.introspect [-] [node: 50fd27b6-7af7-425e-94b2-f6fb0f9f5bfa state starting] Whitelisting MAC's [u'aa:bb:cc:dd:ee:01'] on the firewall
2017-06-07 16:48:51.688 7354 INFO ironic_inspector.introspect [-] [node: 50fd27b6-7af7-425e-94b2-f6fb0f9f5bfa state starting] The following attributes will be used for look up: {u'mac': [u'aa:bb:cc:dd:ee:01']}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_provsion_phase">Deploy/Provsion phase</h2>
<div class="sectionbody">
<hr>
<div class="sect2">
<h3 id="_deploy_phase_recommendations">Deploy phase recommendations</h3>
<div class="paragraph">
<p><strong>Try small scale deployment first</strong></p>
</div>
<div class="paragraph">
<p>Try deployment with the smallest number of nodes possible,Single Controller, single Compute, single CephStorage, etc.</p>
</div>
<div class="paragraph">
<p><strong>Fixed sized Deployment batches</strong></p>
</div>
<div class="paragraph">
<p>We recommend not deploying 32 nodes at a time. 32 is the typical amount you can fit within a 42 RU rack. Deploying 32 at a time also minimizes the debugging necessary to diagnose issues with the deployment.</p>
</div>
<div class="paragraph">
<p><strong>Configure even unused NICs</strong></p>
</div>
<div class="paragraph">
<p>Specify NIC configurations for network interfaces unused by OpenStack Define interfaces in YAML files in the nic-configs directory:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Set use_dhcp: false and defroute: false</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Power off unused nodes</strong></p>
</div>
<div class="paragraph">
<p>Before redeployment, verify that unused nodes are OFF Use DRAC/iLO to check power state Do not relay on Ironic, We have seen cases where nodes from previous deployments which are now in maintenance, are left hanging around in a powered on state causing problems with ongoing deployments.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_phase_debug">Deploy phase Debug</h3>
<div class="paragraph">
<p>In this context we consider deploy the Phase during wich the overcloud image is copied to the local overcloud nodes, this is done booting the undercloud nodes via ipxe to load a ramdisk, then exporting the local root disk as a iscsi target to the undercloud node, and then the overcloud image gets copied via dd</p>
</div>
<div class="paragraph">
<p><strong>Deploy Logs</strong></p>
</div>
<div class="paragraph">
<p>If the deploy fails during deploy the ironic-conductor.log should have the error</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@undercloud ironic]# ls -l /var/log/ironic/ironic-conductor.log
-rw-r--r--. 1 ironic ironic 288970 Jun  7 09:16 /var/log/ironic/ironic-conductor.log</pre>
</div>
</div>
<div class="paragraph">
<p>If you need to check the ramdisk run log output, it is saved in  /var/log/ironic/deploy/ dir</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ironic]# ls -ld  /var/log/ironic/deploy/
drwxr-xr-x. 2 ironic ironic 4096 Jun  5 02:48 /var/log/ironic/deploy/</pre>
</div>
</div>
<div class="paragraph">
<p>Inside the dir you can find a tarball named after the UID of the overcloud node, the journal file contais the output of the run</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ironic]# ls -l  /var/log/ironic/deploy/*tar.gz
-rw-r--r--. 1 ironic ironic 17573 Jun  5 02:48 /var/log/ironic/deploy/d8ee5249-a016-444f-bd02-77e422332381_32068670-ef4e-4699-911f-6c0ed4da541c_2017-06-05-06:48:24.tar.gz
-rw-r--r--. 1 ironic ironic 17806 Jun  5 02:48 /var/log/ironic/deploy/e4cf9855-392c-40be-92b6-9b10674373d0_d92dc0f2-d03c-4cf4-9d1e-36772055520a_2017-06-05-06:48:23.tar.gz
[root@undercloud ironic]# tar -zxvf /var/log/ironic/deploy/d8ee5249-a016-444f-bd02-77e422332381_32068670-ef4e-4699-911f-6c0ed4da541c_2017-06-05-06:48:24.tar.gz &amp;&amp; tail journal
Jun 05 02:48:20 host-10-0-0-62 logger[2251]: 83haiku: debug: /dev/vda1 is not a BeFS partition: exiting
Jun 05 02:48:20 host-10-0-0-62 logger[2251]: 50mounted-tests: debug: running subtest /usr/libexec/os-probes/mounted/90linux-distro
Jun 05 02:48:20 host-10-0-0-62 logger[2251]: 50mounted-tests: debug: running subtest /usr/libexec/os-probes/mounted/90solaris
Jun 05 02:48:20 host-10-0-0-62 logger[2251]: 50mounted-tests: debug: running subtest /usr/libexec/os-probes/mounted/efi
Jun 05 02:48:21 host-10-0-0-62 ironic-python-agent[525]: 2017-06-05 02:48:21.149 525 INFO ironic_python_agent.extensions.image [-] GRUB2 successfully installed on /dev/vda
Jun 05 02:48:21 host-10-0-0-62 kernel: XFS (vda2): Unmounting Filesystem
Jun 05 02:48:21 host-10-0-0-62 ironic-python-agent[525]: 2017-06-05 02:48:21.285 525 INFO root [-] Command image.install_bootloader completed: Command name: install_bootloader, params: {u'efi_system_part_uuid': None, u'root_uuid': u'2a59886b-5268-41e5-b37f-c92611eabd96'}, status: SUCCEEDED, result: None.
Jun 05 02:48:21 host-10-0-0-62 ironic-python-agent[525]: ::ffff:10.0.0.10 - - [05/Jun/2017 02:48:21] "POST /v1/commands?wait=true HTTP/1.1" 200 265
Jun 05 02:48:23 host-10-0-0-62 NetworkManager[186]: &lt;warn&gt;  [1496645303.8756] dhcp4 (eth2): request timed out</pre>
</div>
</div>
<div class="paragraph">
<p><strong>PXE booting in the Deployment Phase</strong></p>
</div>
<div class="paragraph">
<p>The dhcp deployment service is different from the introspection dhcp service, the deployment dnsmasq processes is running inside a namespace created by neutron, when the Ipxe boot starts you will see with ironic node-list the node in wait for callback state, if the node hangs in the wait for callback state the undercloud node is having issues booting ipxe using dhcp, a review of the boot proccess from the system Ilo/console is needed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ~]# ps -ef | grep -i dhcp-hostsfile
nobody    4243     1  0 Jun01 ?        00:00:00 dnsmasq --no-hosts --no-resolv --strict-order --except-interface=lo --pid-file=/var/lib/neutron/dhcp/0ba89bb7-dccd-4001-bb12-5b53ed82c594/pid --dhcp-hostsfile=/var/lib/neutron/dhcp/0ba89bb7-dccd-4001-bb12-5b53ed82c594/host --addn-hosts=/var/lib/neutron/dhcp/0ba89bb7-dccd-4001-bb12-5b53ed82c594/addn_hosts --dhcp-optsfile=/var/lib/neutron/dhcp/0ba89bb7-dccd-4001-bb12-5b53ed82c594/opts --dhcp-leasefile=/var/lib/neutron/dhcp/0ba89bb7-dccd-4001-bb12-5b53ed82c594/leases --dhcp-match=set:ipxe,175 --bind-interfaces --interface=tap9fa1fa7b-14 --dhcp-range=set:tag0,10.0.0.0,static,86400s --dhcp-option-force=option:mtu,1500 --dhcp-lease-max=256 --conf-file=/etc/dnsmasq-ironic.conf</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ~]# ip netns
qdhcp-0ba89bb7-dccd-4001-bb12-5b53ed82c594
[root@undercloud ~]# ip netns exec qdhcp-0ba89bb7-dccd-4001-bb12-5b53ed82c594 ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
9: tap9fa1fa7b-14: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN qlen 1000
    link/ether fa:16:3e:ae:bf:50 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.50/24 brd 10.0.0.255 scope global tap9fa1fa7b-14
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:feae:bf50/64 scope link
       valid_lft forever preferred_lft forever</pre>
</div>
</div>
<div class="paragraph">
<p>So if we want to Tcpdump is better if we do it inside the namespace using the tap device:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[root@undercloud ~]# ip netns exec qdhcp-0ba89bb7-dccd-4001-bb12-5b53ed82c594 tcpdump -i tap9fa1fa7b-14 -vvv -s 1500 '((port 67 or port 68))'</pre>
</div>
</div>
<div class="paragraph">
<p>When the undercloud is a virtual machine running on VMware ESXi, DHCP during Introspection is successful, but it fails during deployment. DHCP requests are being received on the tap device, but the offers are not received by the nodes Forged transmit has to be set to Accept so ESXi does not compare source and effective MAC addresses.  (<a href="https://access.redhat.com/solutions/1980283" class="bare">https://access.redhat.com/solutions/1980283</a>)</p>
</div>
<div class="paragraph">
<p><strong>Populating the overcloud local disks with the overcloud image</strong></p>
</div>
<div class="paragraph">
<p>When we run the overcloud deploy, and the ipxe boot has loaded the ramdisk, a iscsi target is created for the local root disk, from the journal of the deploy ram disk run for and overcloud node:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> Jun 03 09:07:00 host-10-0-0-55 ironic-python-agent[528]: 2017-06-03 09:07:00.668 528 INFO ironic_python_agent.extensions.iscsi [-] Created iSCSI target with iqn iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0, portal port 3260, on device /dev/vda using linux-io
Jun 03 09:07:00 host-10-0-0-55 ironic-python-agent[528]: 2017-06-03 09:07:00.669 528 INFO root [-] Command iscsi.start_iscsi_target completed: Command name: start_iscsi_target, params: {u'wipe_disk_metadata': True, u'iqn': u'iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0', u'portal_port': 3260}, status: SUCCEEDED, result: {'iscsi_target_iqn': u'iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0'}.
Jun 03 09:07:00 host-10-0-0-55 ironic-python-agent[528]: ::ffff:10.0.0.10 - - [03/Jun/2017 09:07:00] "POST /v1/commands?wait=true HTTP/1.1" 200 386</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can see the isci initiator in the undercloud node is connected to the target:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ~]# iscsiadm -m session -P 2
Target: iqn.2008-10.org.openstack:d8ee5249-a016-444f-bd02-77e422332381 (non-flash)
	Current Portal: 10.0.0.52:3260,1
	Persistent Portal: 10.0.0.52:3260,1
		**********
		Interface:
		**********
		Iface Name: default
		Iface Transport: tcp
		Iface Initiatorname: iqn.1994-05.com.redhat:10481c98aef
		Iface IPaddress: 10.0.0.10
		Iface HWaddress: &lt;empty&gt;
		Iface Netdev: &lt;empty&gt;
		SID: 10
		iSCSI Connection State: LOGGED IN
		iSCSI Session State: LOGGED_IN</pre>
</div>
</div>
<div class="paragraph">
<p>After this the copy of the undercloud image starts, if the dd process hangs and doesn&#8217;t finish, load a live usb/iso on the overcloud node that is failing and test the root disk, do a local dd, check for PFAs in the SMART stats,etc.</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ~]# ps -ef | grep -i dd
root      6715  1306  0 05:18 ?        00:00:00 sudo ironic-rootwrap /etc/ironic/rootwrap.conf dd if=/var/lib/ironic/images/e4cf9855-392c-40be-92b6-9b10674373d0/disk of=/dev/disk/by-path/ip-10.0.0.60:3260-iscsi-iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0-lun-1-part2 bs=1M oflag=direct
root      6717  6715  0 05:18 ?        00:00:00 /usr/bin/python2 /usr/bin/ironic-rootwrap /etc/ironic/rootwrap.conf dd if=/var/lib/ironic/images/e4cf9855-392c-40be-92b6-9b10674373d0/disk of=/dev/disk/by-path/ip-10.0.0.60:3260-iscsi-iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0-lun-1-part2 bs=1M oflag=direct
root      6719  6717  2 05:18 ?        00:00:00 /bin/dd if=/var/lib/ironic/images/e4cf9855-392c-40be-92b6-9b10674373d0/disk of=/dev/disk/by-path/ip-10.0.0.60:3260-iscsi-iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0-lun-1-part2 bs=1M oflag=direct</pre>
</div>
</div>
<div class="paragraph">
<p>During this time, Nova is constantly polling Ironic to check whether the node has successfully deployed the overcloud image. It does this by checking the provision state of the node. Once it’s 'active', the deployment has been successful:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ~]# grep -m 1 "Still waiting for ironic node" /var/log/nova/nova-compute.log
2016-09-22 09:12:08.287 11893 DEBUG nova.virt.ironic.driver [-] [instance: 9fefdc3e-0247-4732-bad1-0a87c26a4251] Still waiting for ironic node 875921b3-9864-4aef-8d53-e6a69f2b1fde to unprovision: power_state="power on", target_power_state=None, provision_state="deleting", target_provision_state="available" _log_ironic_polling /usr/lib/python2.7/site-packages/nova/virt/ironic/driver.py:120</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Overview of the deploy stages trough Ironic node states</strong></p>
</div>
<div class="paragraph">
<p>When we first run the overcloud deploy command the ironic nodes go from active to deploying state</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2017-06-08 05:17:13.045 1306 INFO ironic.conductor.task_manager [req-a874331f-e318-40f3-8136-27acd0b0eb38 2d9df91b629246fbaf68145784156541 a0776ed8e5fb4c3e96647dca76ecfd4b - - -] Node e4cf9855-392c-40be-92b6-9b10674373d0 moved to provision state "deploying" from state "available"; target provision state is "active"</pre>
</div>
</div>
<div class="paragraph">
<p>Once the power state of the nodes goes from poweroff to poweron and the iPXE boot starts it changes to wait call-back</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2017-06-08 05:17:26.283 1306 INFO ironic.conductor.task_manager [req-a874331f-e318-40f3-8136-27acd0b0eb38 2d9df91b629246fbaf68145784156541 a0776ed8e5fb4c3e96647dca76ecfd4b - - -] Node e4cf9855-392c-40be-92b6-9b10674373d0 moved to provision state "wait call-back" from state "deploying"; target provision state is "active"</pre>
</div>
</div>
<div class="paragraph">
<p>When the ramdisk is booted correctly the state changes again to deploying</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2017-06-08 05:18:04.809 1306 INFO ironic.conductor.task_manager [req-0526985b-6d49-4684-8d3f-ff446c399ce0 - - - - -] Node e4cf9855-392c-40be-92b6-9b10674373d0 moved to provision state "deploying" from state "wait call-back"; target provision state is "active"</pre>
</div>
</div>
<div class="paragraph">
<p>At this point the ram disk has booted and the iscsi target gets mapped to the undercloud, the dd proccess starts</p>
</div>
<div class="literalblock">
<div class="content">
<pre> 2017-06-08 05:18:07.979 1306 INFO ironic_lib.disk_utils [req-0526985b-6d49-4684-8d3f-ff446c399ce0 - - - - -] Disk metadata on /dev/disk/by-path/ip-10.0.0.60:3260-iscsi-iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0-lun-1 successfully destroyed for node e4cf9855-392c-40be-92b6-9b10674373d0
2017-06-08 05:18:08.840 1306 INFO ironic_lib.disk_utils [req-0526985b-6d49-4684-8d3f-ff446c399ce0 - - - - -] Successfully completed the disk device /dev/disk/by-path/ip-10.0.0.60:3260-iscsi-iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0-lun-1 partitioning for node e4cf9855-392c-40be-92b6-9b10674373d0
2017-06-08 05:18:09.435 1306 INFO ironic_lib.disk_utils [req-0526985b-6d49-4684-8d3f-ff446c399ce0 - - - - -] Configdrive for node e4cf9855-392c-40be-92b6-9b10674373d0 successfully copied onto partition /dev/disk/by-path/ip-10.0.0.60:3260-iscsi-iqn.2008-10.org.openstack:e4cf9855-392c-40be-92b6-9b10674373d0-lun-1-part1
2017-06-08 05:19:37.241 1306 INFO ironic_lib.disk_utils [req-cd605464-c12c-4c58-9b8e-d33c109bd3ad - - - - -] Image for d8ee5249-a016-444f-bd02-77e422332381 successfully populated</pre>
</div>
</div>
<div class="paragraph">
<p>When the dd copy has finished and the overcloud image has been successfully populated, the server goes into active state in ironic, and the deploy phase finishes</p>
</div>
<div class="literalblock">
<div class="content">
<pre> 2017-06-08 05:19:59.857 1306 INFO ironic.conductor.task_manager [req-0526985b-6d49-4684-8d3f-ff446c399ce0 - - - - -] Node e4cf9855-392c-40be-92b6-9b10674373d0 moved to provision state "active" from state "deploying"; target provision state is "None"
2017-06-08 05:19:59.859 1306 INFO ironic.drivers.modules.agent_base_vendor [req-0526985b-6d49-4684-8d3f-ff446c399ce0 - - - - -] Deployment to node e4cf9855-392c-40be-92b6-9b10674373d0 done</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Check root device hints are working</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overcloud_deploy">Overcloud Deploy</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="sect2">
<h3 id="_overcloud_templates">Overcloud templates</h3>
<div class="paragraph">
<p><strong>os-net-config github</strong></p>
</div>
<div class="paragraph">
<p>The os-net-config github has a sample dir with all the combinations that are supported by os-net-config and you can use those examples directly in your net-config/ yaml templates
<a href="http://git.openstack.org/cgit/openstack/os-net-config/tree/etc/os-net-config/samples" class="bare">http://git.openstack.org/cgit/openstack/os-net-config/tree/etc/os-net-config/samples</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_mistral_plans_debug">Mistral Plans Debug</h3>
<div class="paragraph">
<p><strong>The Mistral log is very detailed and useful for in depth debugging</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>tail -f /var/log/mistral/engine.log | grep "ERROR\|tripleo_common";</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Checking Mitral with cli to spot Errors</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud ~]# mistral execution-list | grep "ERROR";
# Grab the execution ID from above.
[root@undercloud ~]# mistral execution-get $EXECUTION_ID
[root@undercloud ~]# mistral execution-get-output $EXECUTION_ID
# Also look at the actions
[root@undercloud ~]# mistral action-execution-list
[root@undercloud ~]# mistral action-execution-get-output $ACTION_ID</pre>
</div>
</div>
<div class="paragraph">
<p>Here is and example, we can check  the exection-list</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]#  mistral execution-list
+------------------------------+------------------------------+------------------------------+------------------------+------------------------------+---------+------------------------------+---------------------+---------------------+
| ID                           | Workflow ID                  | Workflow name                | Description            | Task Execution ID            | State   | State info                   | Created at          | Updated at          |
+------------------------------+------------------------------+------------------------------+------------------------+------------------------------+---------+------------------------------+---------------------+---------------------+
| 8aadba6c-a46d-4b87-aa0d-     | 1ab1c5d1-7408-40e3-b02d-     | tripleo.baremetal.v1.introsp |                        | &lt;none&gt;                       | SUCCESS | None                         | 2017-06-07 08:18:16 | 2017-06-07 09:19:20 |
| d755981f2836                 | 35367fbb809e                 | ect_manageable_nodes         |                        |                              |         |                              |                     |                     |
| 726a96c4-36f7-45ff-9795-b58a | e433d0eb-99cd-450a-a6ae-     | tripleo.baremetal.v1.introsp | sub-workflow execution | 9830243f-a701-48b1-8fcc-     | SUCCESS | None                         | 2017-06-07 08:18:18 | 2017-06-07 09:19:18 |
| bcb93f17                     | 3d525401e368                 | ect                          |                        | 89c3fa2ac501                 |         |                              |                     |                     |</pre>
</div>
</div>
<div class="paragraph">
<p>And check the output using the Execution ID</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]# mistral execution-get-output 726a96c4-36f7-45ff-9795-b58abcb93f17
{
    "status": "SUCCESS",
    "message": "Successfully introspected nodes.",
    "introspected_nodes": {
        "ba4db2bf-c327-4fca-a37e-83cc17c1561a": {
            "uuid": "ba4db2bf-c327-4fca-a37e-83cc17c1561a",</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Manually execute a workflow</strong></p>
</div>
<div class="paragraph">
<p>We can check all the triple workbooks</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]# mistral workbook-list
+----------------------------+--------+---------------------+------------+
| Name                       | Tags   | Created at          | Updated at |
+----------------------------+--------+---------------------+------------+
| tripleo.baremetal.v1       | &lt;none&gt; | 2017-06-01 13:54:18 | None       |
| tripleo.deployment.v1      | &lt;none&gt; | 2017-06-01 13:54:21 | None       |
| tripleo.package_update.v1  | &lt;none&gt; | 2017-06-01 13:54:23 | None       |
| tripleo.plan_management.v1 | &lt;none&gt; | 2017-06-01 13:54:27 | None       |
| tripleo.scale.v1           | &lt;none&gt; | 2017-06-01 13:54:28 | None       |
| tripleo.stack.v1           | &lt;none&gt; | 2017-06-01 13:54:30 | None       |
| tripleo.validations.v1     | &lt;none&gt; | 2017-06-01 13:54:34 | None       |
+----------------------------+--------+---------------------+------------+</pre>
</div>
</div>
<div class="paragraph">
<p>With workflow list, we can check all the workflows for a workbook</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[root@undercloud mistral]#  mistral workflow-list | grep "tripleo.baremetal.v1"  | awk -F "|" '{ print $3 }'
tripleo.baremetal.v1.introspect_manageable_nodes
tripleo.baremetal.v1.set_node_state
tripleo.baremetal.v1.manage
tripleo.baremetal.v1.create_raid_configuration
tripleo.baremetal.v1.manual_cleaning
tripleo.baremetal.v1.tag_nodes
tripleo.baremetal.v1.provide
tripleo.baremetal.v1.register_or_update
tripleo.baremetal.v1.cellv2_discovery
tripleo.baremetal.v1.configure_manageable_nodes
tripleo.baremetal.v1.tag_node
tripleo.baremetal.v1.set_power_state
tripleo.baremetal.v1.provide_manageable_nodes
tripleo.baremetal.v1.configure
tripleo.baremetal.v1.introspect</pre>
</div>
</div>
<div class="paragraph">
<p>We can then use the mistral workflow-get command to se the input parameters needed by the workflow, we are going to use the tripleo.baremetal.v1.provide_manageable_nodes , this simply list ironic nodes in manageable state</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]# mistral workflow-get tripleo.baremetal.v1.provide_manageable_nodes
+------------+-----------------------------------------------+
| Field      | Value                                         |
+------------+-----------------------------------------------+
| ID         | b9977a5c-2f04-40cf-9104-ea1733bb0d45          |
| Name       | tripleo.baremetal.v1.provide_manageable_nodes |
| Project ID | 143c2579d1d749308f92033209fc79c5              |
| Tags       | &lt;none&gt;                                        |
| Input      | queue_name=tripleo                            |
| Created at | 2017-06-01 13:54:18                           |
| Updated at | None                                          |
+------------+-----------------------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>And you can execute the workflow</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]# mistral execution-create  tripleo.baremetal.v1.provide_manageable_nodes '{"queue_name": "tripleo"}'
+-------------------+-----------------------------------------------+
| Field             | Value                                         |
+-------------------+-----------------------------------------------+
| ID                | c6212165-fb42-4a83-8074-05496866bb8e          |
| Workflow ID       | b9977a5c-2f04-40cf-9104-ea1733bb0d45          |
| Workflow name     | tripleo.baremetal.v1.provide_manageable_nodes |
| Description       |                                               |
| Task Execution ID | &lt;none&gt;                                        |
| State             | RUNNING                                       |
| State info        | None                                          |
| Created at        | 2017-06-08 21:25:41                           |
| Updated at        | 2017-06-08 21:25:41                           |
+-------------------+-----------------------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>With the ID we can see the execution list and get the output</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]# mistral execution-list | grep c6212165-fb42-4a83-8074-05496866bb8e
| c6212165-fb42-4a83-8074-05496866bb8e | b9977a5c-2f04-40cf-9104-ea1733bb0d45 | tripleo.baremetal.v1.provide_manageable_nodes           |                        | &lt;none&gt;                               | SUCCESS | None                         | 2017-06-08 21:25:41 | 2017-06-08 21:26:05 |
[root@undercloud mistral]# mistral execution-get-output c6212165-fb42-4a83-8074-05496866bb8e
{
    "managed_nodes": [
        "50fd27b6-7af7-425e-94b2-f6fb0f9f5bfa",
        "ba4db2bf-c327-4fca-a37e-83cc17c1561a"
    ],
    "status": "SUCCESS"
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>You can re-run failed mistral tasks using</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]#  mistral task-list;
# Find the ID for the failed task.
[root@undercloud mistral]#  mistral task-rerun $ID;</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Get your overcloud passwords from mistral</strong></p>
</div>
<div class="paragraph">
<p>A plan is the combination of a as a Swift container + Mistral environment.</p>
</div>
<div class="paragraph">
<p>In swift we have the templates we provided:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]# swift list overcloud | grep net-config
ci/common/net-config-multinode-os-net-config.yaml
ci/common/net-config-multinode.yaml
firstboot/os-net-config-mappings.yaml
net-config-bond.yaml
net-config-bridge.yaml
net-config-linux-bridge.yaml
net-config-noop.yaml
net-config-static-bridge-with-external-dhcp.yaml
net-config-static-bridge.yaml
net-config-static.yaml
net-config-undercloud.yaml
network/scripts/run-os-net-config.sh</pre>
</div>
</div>
<div class="paragraph">
<p>In the mistral enviroment we can find variables includinf the default passwords:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@undercloud mistral]# mistral environment-get overcloud
+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field       | Value                                                                                                                                                                                                                         |
+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Name        | overcloud                                                                                                                                                                                                                     |
| Description | &lt;none&gt;                                                                                                                                                                                                                        |
| Variables   | {                                                                                                                                                                                                                             |
|             |     "parameter_defaults": {                                                                                                                                                                                                   |
|             |         "ControllerCount": 1,                                                                                                                                                                                                 |
|             |         "NovaComputeLibvirtType": "qemu",                                                                                                                                                                                     |
|             |         "NtpServer": "95.81.173.74",                                                                                                                                                                                          |
|             |         "ComputeCount": 1,                                                                                                                                                                                                    |
|             |         "StackAction": "CREATE",                                                                                                                                                                                              |
|             |         "OvercloudComputeFlavor": "compute",                                                                                                                                                                                  |
|             |         "OvercloudControlFlavor": "control",                                                                                                                                                                                  |
|             |         "UpdateIdentifier": ""                                                                                                                                                                                                |
|             |     },                                                                                                                                                                                                                        |
|             |     "passwords": {                                                                                                                                                                                                            |
|             |         "KeystoneFernetKey1": "cbTCTW5nGP-8u7x9jw6ti9_t65YUsByy8EBdw3XkNao=",                                                                                                                                                 |
|             |         "KeystoneFernetKey0": "xbwAGJ_-Y-LVbIcH9PlNiCVb4NT_5EyfG0rRoVXOkDM=",                                                                                                                                                 |
|             |         "HAProxyStatsPassword": "EdDx72ybkwDw4b2KM3tkdN7bT",                                                                                                                                                                  |
|             |         "HeatPassword": "dUR9C9Qy4eBxgD82usZhvGFsD",                                                                                                                                                                          |
|             |         "KeystoneCredential1": "h7AQ-HYvOFzpU7Lxb2bFywYkEkK3l9dJDRXFw1Kl7xI=",                                                                                                                                                |
|             |         "CongressPassword": "pKNBHNWrxsRpjVpRJYgcjMwgp",                                                                                                                                                                      |
|             |         "NeutronPassword": "YPDgACsfmN4uGHcnzebc3rEJv",                                                                                                                                                                       |
|             |         "SnmpdReadonlyUserPassword": "bcc0f245d947ea6b62eea3aa63bdbfb3380ff0b5",                                                                                                                                              |
|             |         "GlancePassword": "Nwy9PbgccFv7K2AFpjfQs9tG8",                                                                                                                                                                        |
|             |         "AdminPassword": "YjrqYfGvhfpmatkzpHD9R9myj",                                                                                                                                                                         |
|             |         "IronicPassword": "KhKes3scq9tEd9B3GPf37jRTr",                                                                                                                                                                        |
|             |         "HeatStackDomainAdminPassword": "VkE48BwexxcCZXM9DR4putAPT",                                                                                                                                                          |
|             |         "ZaqarPassword": "F86nYgsqmHbedfMfReUJXpVra",                                                                                                                                                                         |</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Mistral By Example: Full overcloud install using Mistral</strong></p>
</div>
<div class="paragraph">
<p><a href="http://tripleo.org/mistral-api/mistral-api.html" class="bare">http://tripleo.org/mistral-api/mistral-api.html</a></p>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_overcloud_deploy_debug">Overcloud Deploy Debug</h3>
<div class="paragraph">
<p><strong>Follow the error in heat</strong></p>
</div>
<div class="paragraph">
<p>Following an error on the overcloud stack list, we first check that the overcloud stack has failed</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ heat stack-list
WARNING (shell) "heat stack-list" is deprecated, please use "openstack stack list" instead
+--------------------------------------+------------+---------------+----------------------+--------------+
| id                                   | stack_name | stack_status  | creation_time        | updated_time |
+--------------------------------------+------------+---------------+----------------------+--------------+
| a7681ece-034d-4fba-8874-7803601b9507 | overcloud  | CREATE_FAILED | 2017-06-12T13:34:13Z | None         |
+--------------------------------------+------------+---------------+----------------------+--------------+</pre>
</div>
</div>
<div class="paragraph">
<p>We can then list the resources of the stack, the compute resource group has failed</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$  openstack stack resource list overcloud | grep -i Failed
| Compute                                   | 6f30d573-685b-468d-b225-fdba504f2533         | OS::Heat::ResourceGroup                         | CREATE_FAILED   | 2017-06-12T13:34:13Z |</pre>
</div>
</div>
<div class="paragraph">
<p>We can dig in deeper, going into the nested stacks, we can see that the node that has failed is compute node 0</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ openstack stack resource list 6f30d573-685b-468d-b225-fdba504f2533 | grep FAILED
| 0             | f9c1c76e-f7a7-4770-9bd0-a4c49e480d84 | OS::TripleO::Compute | CREATE_FAILED   | 2017-06-12T13:34:53Z |</pre>
</div>
</div>
<div class="paragraph">
<p>If we check in the compute 0 stack, we can see we have to failed SoftwareDeployment resources</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ openstack stack resource list  f9c1c76e-f7a7-4770-9bd0-a4c49e480d84 | grep FAILED
| NetworkDeployment     | 3fcbbf55-1238-4d36-9539-53e40ef2e136 | OS::TripleO::SoftwareDeployment              | CREATE_FAILED   | 2017-06-12T13:34:54Z |
| UpdateDeployment      | d7fc1305-9b55-4afb-8612-db2917b11505 | OS::Heat::SoftwareDeployment                 | CREATE_FAILED   | 2017-06-12T13:34:54Z |</pre>
</div>
</div>
<div class="paragraph">
<p>We can get this info in 1 command using the nested depth option on the cli</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ openstack stack resource list -n5 overcloud | grep FAILED
| Compute                                   | 6f30d573-685b-468d-b225-fdba504f2533                                            | OS::Heat::ResourceGroup                                                                                             | CREATE_FAILED   | 2017-06-12T13:34:13Z | overcloud                                                                                                            |
| 0                                         | f9c1c76e-f7a7-4770-9bd0-a4c49e480d84                                            | OS::TripleO::Compute                                                                                                | CREATE_FAILED   | 2017-06-12T13:34:53Z | overcloud-Compute-f7gr76kpxqaz                                                                                       |
| UpdateDeployment                          | d7fc1305-9b55-4afb-8612-db2917b11505                                            | OS::Heat::SoftwareDeployment                                                                                        | CREATE_FAILED   | 2017-06-12T13:34:54Z | overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu                                                                        |
| NetworkDeployment                         | 3fcbbf55-1238-4d36-9539-53e40ef2e136                                            | OS::TripleO::SoftwareDeployment                                                                                     | CREATE_FAILED   | 2017-06-12T13:34:54Z | overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu                                                                        |</pre>
</div>
</div>
<div class="paragraph">
<p>Once we know where the error is, we can use resource show to check the attributes</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ openstack stack resource list overcloud | grep -i failed
| Compute                                   | 6f30d573-685b-468d-b225-fdba504f2533         | OS::Heat::ResourceGroup                         | CREATE_FAILED   | 2017-06-12T13:34:13Z |
[stack@undercloud ~]$ openstack stack resource list 6f30d573-685b-468d-b225-fdba504f2533
+---------------+--------------------------------------+----------------------+-----------------+----------------------+
| resource_name | physical_resource_id                 | resource_type        | resource_status | updated_time         |
+---------------+--------------------------------------+----------------------+-----------------+----------------------+
| 0             | f9c1c76e-f7a7-4770-9bd0-a4c49e480d84 | OS::TripleO::Compute | CREATE_FAILED   | 2017-06-12T13:34:53Z |
+---------------+--------------------------------------+----------------------+-----------------+----------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>With resource show we have to specify the stack(can be nested) and the resource name, in this example the stack id is the compute resource-id that we get from the previous command</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ openstack stack resource show 6f30d573-685b-468d-b225-fdba504f2533 0
+------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                  | Value                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| attributes             | {u'storage_mgmt_ip_address': u'10.0.0.59', u'nova_server_resource': u'c05fc792-3807-4bd0-becd-d7fc5035474b', u'hostname': u'overcloud-compute-0', u'tenant_ip_address': u'192.168.3.154', u'external_ip_address':  |
|                        | u'10.0.0.59', u'known_hosts_entry': u'192.168.2.154,overcloud-compute-0.liquid.zz,overcloud-compute-0,10.0.0.59,overcloud-compute-0.external.liquid.zz,overcloud-compute-0.external,192.168.2.154,overcloud-       |
|                        | compute-0.internalapi.liquid.zz,overcloud-compute-0.internalapi,172.16.1.12,overcloud-compute-0.storage.liquid.zz,overcloud-compute-0.storage,10.0.0.59,overcloud-compute-0.storagemgmt.liquid.zz,overcloud-       |
|                        | compute-0.storagemgmt,192.168.3.154,overcloud-compute-0.tenant.liquid.zz,overcloud-compute-0.tenant,10.0.0.59,overcloud-compute-0.management.liquid.zz,overcloud-compute-0.management,10.0.0.59,overcloud-         |
|                        | compute-0.ctlplane.liquid.zz,overcloud-compute-0.ctlplane ', u'hosts_entry': u'192.168.2.154 overcloud-compute-0.liquid.zz overcloud-compute-0\n10.0.0.59 overcloud-compute-0.external.liquid.zz overcloud-        |
|                        | compute-0.external\n192.168.2.154 overcloud-compute-0.internalapi.liquid.zz overcloud-compute-0.internalapi\n172.16.1.12 overcloud-compute-0.storage.liquid.zz overcloud-compute-0.storage\n10.0.0.59 overcloud-   |
|                        | compute-0.storagemgmt.liquid.zz overcloud-compute-0.storagemgmt\n192.168.3.154 overcloud-compute-0.tenant.liquid.zz overcloud-compute-0.tenant\n10.0.0.59 overcloud-compute-0.management.liquid.zz overcloud-      |
|                        | compute-0.management\n10.0.0.59 overcloud-compute-0.ctlplane.liquid.zz overcloud-compute-0.ctlplane\n', u'storage_ip_address': u'172.16.1.12', u'hostname_map': {u'management': u'overcloud-                       |
|                        | compute-0.management.liquid.zz', u'storage': u'overcloud-compute-0.storage.liquid.zz', u'ctlplane': u'overcloud-compute-0.ctlplane.liquid.zz', u'external': u'overcloud-compute-0.external.liquid.zz',             |
|                        | u'internal_api': u'overcloud-compute-0.internalapi.liquid.zz', u'storage_mgmt': u'overcloud-compute-0.storagemgmt.liquid.zz', u'tenant': u'overcloud-compute-0.tenant.liquid.zz'}, u'internal_api_ip_address':     |
|                        | u'192.168.2.154', u'ip_address': u'10.0.0.59', u'management_ip_address': u'10.0.0.59'}                                                                                                                             |
| creation_time          | 2017-06-12T13:34:53Z                                                                                                                                                                                               |
| description            |                                                                                                                                                                                                                    |
| links                  | [{u'href': u'http://10.0.0.10:8004/v1/e6128b61cf7a4169a8f61cdf41a27344/stacks/overcloud-Compute-f7gr76kpxqaz/6f30d573-685b-468d-b225-fdba504f2533/resources/0', u'rel': u'self'}, {u'href':                        |
|                        | u'http://10.0.0.10:8004/v1/e6128b61cf7a4169a8f61cdf41a27344/stacks/overcloud-Compute-f7gr76kpxqaz/6f30d573-685b-468d-b225-fdba504f2533', u'rel': u'stack'}, {u'href':                                              |
|                        | u'http://10.0.0.10:8004/v1/e6128b61cf7a4169a8f61cdf41a27344/stacks/overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu/f9c1c76e-f7a7-4770-9bd0-a4c49e480d84', u'rel': u'nested'}]                                        |
| logical_resource_id    | 0                                                                                                                                                                                                                  |
| parent_resource        | Compute                                                                                                                                                                                                            |
| physical_resource_id   | f9c1c76e-f7a7-4770-9bd0-a4c49e480d84                                                                                                                                                                               |
| required_by            | []                                                                                                                                                                                                                 |
| resource_name          | 0                                                                                                                                                                                                                  |
| resource_status        | CREATE_FAILED                                                                                                                                                                                                      |
| resource_status_reason | CREATE aborted                                                                                                                                                                                                     |
| resource_type          | OS::TripleO::Compute                                                                                                                                                                                               |
| updated_time           | 2017-06-12T13:34:53Z                                                                                                                                                                                               |
+------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the attributes of the previous command we can see something strange is going on, we have several ip definitions with the same IP: storage_mgmt_ip_address': u'10.0.0.59, external_ip_address: u'10.0.0.59'</p>
</div>
<div class="paragraph">
<p>We can still try and get more info from the resources in the last stack:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ openstack stack resource list f9c1c76e-f7a7-4770-9bd0-a4c49e480d84 | grep FAILED
+-----------------------+--------------------------------------+----------------------------------------------+-----------------+----------------------+
| resource_name         | physical_resource_id                 | resource_type                                | resource_status | updated_time         |
+-----------------------+--------------------------------------+----------------------------------------------+-----------------+----------------------+
| NetworkDeployment     | 3fcbbf55-1238-4d36-9539-53e40ef2e136 | OS::TripleO::SoftwareDeployment              | CREATE_FAILED   | 2017-06-12T13:34:54Z |
| UpdateDeployment      | d7fc1305-9b55-4afb-8612-db2917b11505 | OS::Heat::SoftwareDeployment                 | CREATE_FAILED   | 2017-06-12T13:34:54Z |
+-----------------------+--------------------------------------+----------------------------------------------+-----------------+----------------------+
[stack@undercloud ~]$ openstack stack resource show f9c1c76e-f7a7-4770-9bd0-a4c49e480d84 NetworkDeployment
+------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                  | Value                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| attributes             | {u'deploy_stdout': None, u'deploy_stderr': None, u'deploy_status_code': None}                                                                                                                                      |
| creation_time          | 2017-06-12T13:34:54Z                                                                                                                                                                                               |
| description            |                                                                                                                                                                                                                    |
| links                  | [{u'href': u'http://10.0.0.10:8004/v1/e6128b61cf7a4169a8f61cdf41a27344/stacks/overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu/f9c1c76e-f7a7-4770-9bd0-a4c49e480d84/resources/NetworkDeployment', u'rel': u'self'},   |
|                        | {u'href': u'http://10.0.0.10:8004/v1/e6128b61cf7a4169a8f61cdf41a27344/stacks/overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu/f9c1c76e-f7a7-4770-9bd0-a4c49e480d84', u'rel': u'stack'}]                               |
| logical_resource_id    | NetworkDeployment                                                                                                                                                                                                  |
| parent_resource        | 0                                                                                                                                                                                                                  |
| physical_resource_id   | 3fcbbf55-1238-4d36-9539-53e40ef2e136                                                                                                                                                                               |
| required_by            | [u'NovaComputeDeployment']                                                                                                                                                                                         |
| resource_name          | NetworkDeployment                                                                                                                                                                                                  |
| resource_status        | CREATE_FAILED                                                                                                                                                                                                      |
| resource_status_reason | CREATE aborted                                                                                                                                                                                                     |
| resource_type          | OS::TripleO::SoftwareDeployment                                                                                                                                                                                    |
| updated_time           | 2017-06-12T13:34:54Z                                                                                                                                                                                               |
+------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
[stack@undercloud ~]$ openstack stack resource show f9c1c76e-f7a7-4770-9bd0-a4c49e480d84 UpdateDeployment
+------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                  | Value                                                                                                                                                                                                              |
+------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| attributes             | {u'deploy_stdout': None, u'deploy_stderr': None, u'deploy_status_code': None}                                                                                                                                      |
| creation_time          | 2017-06-12T13:34:54Z                                                                                                                                                                                               |
| description            |                                                                                                                                                                                                                    |
| links                  | [{u'href': u'http://10.0.0.10:8004/v1/e6128b61cf7a4169a8f61cdf41a27344/stacks/overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu/f9c1c76e-f7a7-4770-9bd0-a4c49e480d84/resources/UpdateDeployment', u'rel': u'self'},    |
|                        | {u'href': u'http://10.0.0.10:8004/v1/e6128b61cf7a4169a8f61cdf41a27344/stacks/overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu/f9c1c76e-f7a7-4770-9bd0-a4c49e480d84', u'rel': u'stack'}]                               |
| logical_resource_id    | UpdateDeployment                                                                                                                                                                                                   |
| parent_resource        | 0                                                                                                                                                                                                                  |
| physical_resource_id   | d7fc1305-9b55-4afb-8612-db2917b11505                                                                                                                                                                               |
| required_by            | [u'NovaComputeDeployment']                                                                                                                                                                                         |
| resource_name          | UpdateDeployment                                                                                                                                                                                                   |
| resource_status        | CREATE_FAILED                                                                                                                                                                                                      |
| resource_status_reason | CREATE aborted                                                                                                                                                                                                     |
| resource_type          | OS::Heat::SoftwareDeployment                                                                                                                                                                                       |
| updated_time           | 2017-06-12T13:34:54Z                                                                                                                                                                                               |</pre>
</div>
</div>
<div class="paragraph">
<p>We can also use the deploy show to get output of the failed command, here we can see as input valus the configuration of the br-ex bridge with nic1</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ heat resource-list -n5 overcloud | grep SoftwareDeployment | grep CREATE_FAILED
WARNING (shell) "heat resource-list" is deprecated, please use "openstack stack resource list" instead
| NetworkDeployment                         | 3fcbbf55-1238-4d36-9539-53e40ef2e136                                            | OS::TripleO::SoftwareDeployment                                                                                     | CREATE_FAILED   | 2017-06-12T13:34:54Z | overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu                                                                        |
| UpdateDeployment                          | d7fc1305-9b55-4afb-8612-db2917b11505                                            | OS::Heat::SoftwareDeployment                                                                                        | CREATE_FAILED   | 2017-06-12T13:34:54Z | overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu                                                                        |
[stack@undercloud ~]$ heat deployment-show 3fcbbf55-1238-4d36-9539-53e40ef2e136
WARNING (shell) "heat deployment-show" is deprecated, please use "openstack software deployment show" instead
{
  "status": "IN_PROGRESS",
  "server_id": "c05fc792-3807-4bd0-becd-d7fc5035474b",
  "config_id": "43d20c1e-94c4-41de-b657-b522edbb5c0c",
  "output_values": null,
  "creation_time": "2017-06-12T13:40:14Z",
  "input_values": {
    "interface_name": "nic1",
    "bridge_name": "br-ex"
  },
  "action": "CREATE",
  "status_reason": "Deploy data available",
  "id": "3fcbbf55-1238-4d36-9539-53e40ef2e136"
}
[stack@undercloud ~]$ heat deployment-show d7fc1305-9b55-4afb-8612-db2917b11505
WARNING (shell) "heat deployment-show" is deprecated, please use "openstack software deployment show" instead
{
  "status": "IN_PROGRESS",
  "server_id": "c05fc792-3807-4bd0-becd-d7fc5035474b",
  "config_id": "d0134c5e-3aae-4a6a-98f4-5c577a41d24c",
  "output_values": null,
  "creation_time": "2017-06-12T13:40:08Z",
  "input_values": {
    "update_identifier": ""
  },
  "action": "CREATE",
  "status_reason": "Deploy data available",
  "id": "d7fc1305-9b55-4afb-8612-db2917b11505"
}</pre>
</div>
</div>
<div class="paragraph">
<p>To get more details on these deployments we can use the heat config-list/config-show commands</p>
</div>
<div class="paragraph">
<p>We first get the deployment id:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ heat resource-list -n5 overcloud | grep SoftwareDeployment | grep CREATE_FAILED
WARNING (shell) "heat resource-list" is deprecated, please use "openstack stack resource list" instead
| NetworkDeployment                         | 3fcbbf55-1238-4d36-9539-53e40ef2e136                                            | OS::TripleO::SoftwareDeployment                                                                                     | CREATE_FAILED   | 2017-06-12T13:34:54Z | overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu                                                                        |
| UpdateDeployment                          | d7fc1305-9b55-4afb-8612-db2917b11505                                            | OS::Heat::SoftwareDeployment                                                                                        | CREATE_FAILED   | 2017-06-12T13:34:54Z | overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu                                                                        |</pre>
</div>
</div>
<div class="paragraph">
<p>With the deployment id, we grep it to get the config id</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$  heat deployment-list | grep 3fcbbf55-1238-4d36-9539-53e40ef2e136
WARNING (shell) "heat deployment-list" is deprecated, please use "openstack software deployment list" instead
| 3fcbbf55-1238-4d36-9539-53e40ef2e136 | 43d20c1e-94c4-41de-b657-b522edbb5c0c | c05fc792-3807-4bd0-becd-d7fc5035474b | CREATE | IN_PROGRESS | 2017-06-12T13:40:14Z | Deploy data available |</pre>
</div>
</div>
<div class="paragraph">
<p>The second column is the config id, once we have it we can do a config show and see what inputs have been passed to os-net-config on the compute 0 host:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ heat config-show 43d20c1e-94c4-41de-b657-b522edbb5c0c
WARNING (shell) "heat config-show" is deprecated, please use "openstack software config show" instead
{
  "inputs": [
    {
      "type": "String",
      "name": "interface_name",
      "value": "nic1"
    },
    {
      "type": "String",
      "name": "bridge_name",
      "value": "br-ex"
    },
    {
      "type": "String",
      "name": "deploy_server_id",
      "value": "c05fc792-3807-4bd0-becd-d7fc5035474b",
      "description": "ID of the server being deployed to"
    },
    {
      "type": "String",
      "name": "deploy_action",
      "value": "CREATE",
      "description": "Name of the current action being deployed"
    },
    {
      "type": "String",
      "name": "deploy_stack_id",
      "value": "overcloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu/f9c1c76e-f7a7-4770-9bd0-a4c49e480d84",
      "description": "ID of the stack this deployment belongs to"
    },
    {
      "type": "String",
      "name": "deploy_resource_name",
      "value": "NetworkDeployment",
      "description": "Name of this deployment resource in the stack"
    },
    {
      "type": "String",
      "name": "deploy_signal_transport",
      "value": "CFN_SIGNAL",
      "description": "How the server should signal to heat with the deployment output values."
    },
    {
      "type": "String",
      "name": "deploy_signal_id",
      "value": "http://10.0.0.10:8000/v1/signal/arn%3Aopenstack%3Aheat%3A%3Ae6128b61cf7a4169a8f61cdf41a27344%3Astacks%2Fovercloud-Compute-f7gr76kpxqaz-0-h42tisowbbuu%2Ff9c1c76e-f7a7-4770-9bd0-a4c49e480d84%2Fresources%2FNetworkDeployment?Timestamp=2017-06-12T13%3A34%3A54Z&amp;SignatureMethod=HmacSHA256&amp;AWSAccessKeyId=38be6b4a84d24b429a6b6fcf434535e5&amp;SignatureVersion=2&amp;Signature=XBnVw%2BUhMBj56vdkjJcNfV5kjylCkJLQ%2FGHec61iLDQ%3D",
      "description": "ID of signal to use for signaling output values"
    },
    {
      "type": "String",
      "name": "deploy_signal_verb",
      "value": "POST",
      "description": "HTTP verb to use for signaling outputvalues"
    }
  ],
  "group": "os-apply-config",
  "name": "NetworkDeployment",
  "outputs": [],
  "creation_time": "2017-06-12T13:40:13Z",
  "options": {},
  "config": {
    "os_net_config": {
      "network_config": [
        {
          "addresses": [
            {
              "ip_netmask": "10.0.0.59/24"
            }
          ],
          "bonding_options": "mode=1 miimon=150",
          "members": [
            {
              "type": "interface",
              "name": "eth0",
              "primary": true
            },
            {
              "type": "interface",
              "name": "eth1"
            }
          ],
          "routes": [
            {
              "ip_netmask": "169.254.169.254/32",
              "next_hop": "10.0.0.10"
            }
          ],
          "use_dhcp": false,
          "type": "linux_bond",
          "name": "bond0"
        },
        {
          "dns_servers": [
            "192.168.101.1",
            "8.8.8.8"
          ],
          "type": "ovs_bridge",
          "name": "br-tenant",
          "members": [
            {
              "type": "linux_bond",
              "bonding_options": "mode=1 miimon=150",
              "members": [
                {
                  "type": "interface",
                  "name": "eth2",
                  "primary": true
                },
                {
                  "type": "interface",
                  "name": "eth3"
                }
              ],
              "name": "bond1"
            },
            {
              "device": "bond1",
              "use_dhcp": false,
              "type": "vlan",
              "addresses": [
                {
                  "ip_netmask": "192.168.3.154/24"
                }
              ],
              "vlan_id": 300
            },
            {
              "addresses": [
                {
                  "ip_netmask": "10.0.0.59/24"
                }
              ],
              "routes": [
                {
                  "default": true,
                  "next_hop": "192.168.101.1"
                }
              ],
              "device": "bond1",
              "use_dhcp": false,
              "type": "vlan",
              "vlan_id": 101
            }
          ]
        },
        {
          "dns_servers": [
            "192.168.101.1",
            "8.8.8.8"
          ],
          "type": "ovs_bridge",
          "name": "br-api",
          "members": [
            {
              "use_dhcp": false,
              "type": "linux_bond",
              "bonding_options": "mode=1 miimon=150",
              "members": [
                {
                  "type": "interface",
                  "name": "eth4",
                  "primary": true
                },
                {
                  "type": "interface",
                  "name": "eth5"
                }
              ],
              "name": "bond2"
            },
            {
              "device": "bond2",
              "use_dhcp": false,
              "type": "vlan",
              "addresses": [
                {
                  "ip_netmask": "192.168.2.154/24"
                }
              ],
              "vlan_id": 200
            }
          ]
        },
        {
          "dns_servers": [
            "192.168.101.1",
            "8.8.8.8"
          ],
          "type": "ovs_bridge",
          "name": "br-storage",
          "members": [
            {
              "type": "linux_bond",
              "bonding_options": "mode=1 miimon=150",
              "members": [
                {
                  "type": "interface",
                  "name": "eth6",
                  "primary": true
                },
                {
                  "type": "interface",
                  "name": "eth7"
                }
              ],
              "name": "bond3"
            },
            {
              "device": "bond3",
              "use_dhcp": false,
              "type": "vlan",
              "addresses": [
                {
                  "ip_netmask": "10.0.0.59/24"
                }
              ],
              "vlan_id": 100
            }
          ]
        }
      ]
    }
  },
  "id": "43d20c1e-94c4-41de-b657-b522edbb5c0c"
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Checking Errors from the Overcloud Node</strong></p>
</div>
<div class="paragraph">
<p>Once the nodes are deployed we can access them via ILO if no network has been configured, or via SSH using the heat-admin user from the undercloud node.
To be able to access the overcloud node via the ILO we need to have previously modified the overcloud image to add a root passwd</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#virt-customize -a overcloud-full.qcow2 --root-password password:test</pre>
</div>
</div>
<div class="paragraph">
<p>In this example we check the stack resource list and see that the controller nodes have been stuck a long time in network deployment</p>
</div>
<div class="literalblock">
<div class="content">
<pre> 2017-06-13 14:38:05Z [overcloud.Controller.0.NetworkDeployment]: CREATE_IN_PROGRESS  state changed
2017-06-13 14:38:06Z [overcloud.Controller.1.NetworkDeployment]: CREATE_IN_PROGRESS  state changed
2017-06-13 14:38:07Z [overcloud.Controller.2.NetworkDeployment]: CREATE_IN_PROGRESS  state changed</pre>
</div>
</div>
<div class="paragraph">
<p>We are going to connect via ipmi to check whats happening.</p>
</div>
<div class="literalblock">
<div class="content">
<pre> root@overcloud-controller-0 log]# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether aa:bb:cc:dd:ee:01 brd ff:ff:ff:ff:ff:ff
3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:7a:67:df brd ff:ff:ff:ff:ff:ff
4: eth2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:8f:3d:8a brd ff:ff:ff:ff:ff:ff
5: eth3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:d3:8f:e4 brd ff:ff:ff:ff:ff:ff
6: eth4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:4c:cc:8d brd ff:ff:ff:ff:ff:ff
7: eth5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:14:6e:eb brd ff:ff:ff:ff:ff:ff
8: eth6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:c6:09:20 brd ff:ff:ff:ff:ff:ff
9: eth7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:45:64:c7 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::5054:ff:fe45:64c7/64 scope link
       valid_lft forever preferred_lft forever</pre>
</div>
</div>
<div class="paragraph">
<p>Network is not configured, lets check if the needed processes are running:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-0 os-net-config]# ps ax | grep -e os- -e heat
ps ax | grep -e os- -e heat
 2966 ?        Ss     0:01 /usr/bin/python /usr/bin/os-collect-config
11155 ttyS0    S+     0:00 grep --color=auto -e os- -e heat</pre>
</div>
</div>
<div class="paragraph">
<p>We can see that os-collect-config is running, but we don&#8217;t have the heat client, nor the os-refresh-config process.</p>
</div>
<div class="paragraph">
<p>Also /var/lib/heat-config dir is empty, so no config files have been copied from the undercloud</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-0 os-net-config]# ls /var/lib/heat-config
deployed</pre>
</div>
</div>
<div class="paragraph">
<p>We can check the system logs and see, that we can&#8217;t access the metadata server:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Jun 13 10:44:44 overcloud-controller-0 os-collect-config: HTTPConnectionPool(host='169.254.169.254', port=80): Max retries exceeded with url: /latest/meta-data/ (Caused by NewConnectionError('&lt;requests.packages.urllib3.connection.HTTPConnection object at 0x3acfbd0&gt;: Failed to establish a new connection: [Errno 101] Network is unreachable',))</pre>
</div>
</div>
<div class="paragraph">
<p>If we check for os-net-config in the messages file, we can look for errors in the network config</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-1 ~]# cat /var/log/messages | grep -A 80 "os-net-config -c"
ig -c"ar/log/messages | grep -A 80 "os-net-conf
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + os-net-config -c /etc/os-net-config/config.json -v --detailed-exit-codes
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] Using config file at: /etc/os-net-config/config.json
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] Using mapping file at: /etc/os-net-config/mapping.yaml
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] Ifcfg net config provider created.
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] nic8 mapped to: eth7
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] nic7 mapped to: eth6
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] nic6 mapped to: eth5
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] nic5 mapped to: eth4
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] nic4 mapped to: eth3
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] nic3 mapped to: eth2
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] nic2 mapped to: eth1
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] nic1 mapped to: eth0
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding linux bond: bond0
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding custom route for interface: bond0
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding interface: eth0
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding interface: eth1
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding bridge: br-tenant
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding interface: eth2
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding vlan: vlan300
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding bridge: br-api
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding linux bond: bond2
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding interface: eth4
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding interface: eth5
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding vlan: vlan200
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding bridge: br-storage
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding linux bond: bond3
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding interface: eth6
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding interface: eth7
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: [2017/06/13 10:38:09 AM] [INFO] adding vlan: vlan100
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: Traceback (most recent call last):
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: File "/usr/bin/os-net-config", line 10, in &lt;module&gt;
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: sys.exit(main())
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: File "/usr/lib/python2.7/site-packages/os_net_config/cli.py", line 184, in main
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: obj = objects.object_from_json(iface_json)
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: File "/usr/lib/python2.7/site-packages/os_net_config/objects.py", line 38, in object_from_json
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: return Interface.from_json(json)
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: File "/usr/lib/python2.7/site-packages/os_net_config/objects.py", line 299, in from_json
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: opts = _BaseOpts.base_opts_from_json(json)
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: File "/usr/lib/python2.7/site-packages/os_net_config/objects.py", line 253, in base_opts_from_json
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: addresses.append(Address.from_json(address))
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: File "/usr/lib/python2.7/site-packages/os_net_config/objects.py", line 171, in from_json
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: ip_netmask = _get_required_field(json, 'ip_netmask', 'Address')
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: File "/usr/lib/python2.7/site-packages/os_net_config/objects.py", line 78, in _get_required_field
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: raise InvalidConfigException(msg)
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: os_net_config.objects.InvalidConfigException: Address JSON objects require 'ip_netmask' to be configured.
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + RETVAL=1
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + [[ 1 == 2 ]]
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + [[ 1 != 0 ]]
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + echo 'ERROR: os-net-config configuration failed.'
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: ERROR: os-net-config configuration failed.
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + exit 1
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + configure_safe_defaults
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + [[ 1 == 0 ]]
Jun 13 10:38:09 overcloud-controller-1 os-collect-config: + cat</pre>
</div>
</div>
<div class="paragraph">
<p>We can see that os-net-config says there is no ip_netmask configure for vlan100, we can take at the config file being user by os-net-config</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-1 ~]# cat /etc/os-net-config/config.json | jq .
cat /etc/o s-net-config/config.json | jq .
{
  "network_config": [
    {
      "name": "bond0",
      "type": "linux_bond",
      "use_dhcp": false,
      "routes": [
        {
          "next_hop": "10.0.0.10",
          "ip_netmask": "169.254.169.254/32"
        }
      ],
      "members": [
        {
          "primary": true,
          "name": "eth0",
          "type": "interface"
        },
        {
          "name": "eth1",
          "type": "interface"
        }
      ],
      "bonding_options": "mode=1 miimon=150",
      "addresses": [
        {
          "ip_netmask": "10.0.0.58/24"
        }
      ]
    },
    {
      "members": [
        {
          "primary": true,
          "name": "eth2",
          "type": "interface"
        },
        {
          "vlan_id": 300,
          "addresses": [
            {
              "ip_netmask": "192.168.3.151/24"
            }
          ],
          "type": "vlan",
          "use_dhcp": false
        }
      ],
      "name": "br-tenant",
      "type": "ovs_bridge",
      "dns_servers": [
        "192.168.101.1",
        "8.8.8.8"
      ]
    },
    {
      "members": [
        {
          "name": "bond2",
          "members": [
            {
              "primary": true,
              "name": "eth4",
              "type": "interface"
            },
            {
              "name": "eth5",
              "type": "interface"
            }
          ],
          "bonding_options": "mode=1 miimon=150",
          "type": "linux_bond"
        },
        {
          "vlan_id": 200,
          "addresses": [
            {
              "ip_netmask": "192.168.2.151/24"
            }
          ],
          "type": "vlan",
          "device": "bond2"
        }
      ],
      "name": "br-api",
      "type": "ovs_bridge",
      "dns_servers": [
        "192.168.101.1",
        "8.8.8.8"
      ]
    },
    {
      "members": [
        {
          "name": "bond3",
          "members": [
            {
              "primary": true,
              "name": "eth6",
              "type": "interface"
            },
            {
              "name": "eth7",
              "type": "interface"
            }
          ],
          "bonding_options": "mode=1 miimon=150",
          "type": "linux_bond"
        },
        {
          "vlan_id": 100,
          "addresses": [
            {
              "ip_netmask": "192.168.1.151/24"
            }
          ],
          "type": "vlan",
          "device": "bond3"
        }
      ],
      "name": "br-storage",
      "type": "ovs_bridge",
      "dns_servers": [
        "192.168.101.1",
        "8.8.8.8"
      ]
    },
    {
      "name": "eth3",
      "vlan_id": 101,
      "addresses": [
        {
          "ip_netmask": "192.168.101.151/24",
          "routes": null
        },
        {
          "next_hop": "192.168.101.1",
          "default": true
        }
      ],
      "type": "interface",
      "use_dhcp": false
    }
  ]
}</pre>
</div>
</div>
<div class="paragraph">
<p>Looks like something is wrong with eth3, the first problem is that the eth3 device doesn&#8217;t have vlans, is a access port, to do tests for a valid config we can modify the file in /etc/os-net-config</p>
</div>
<div class="literalblock">
<div class="content">
<pre> root@overcloud-controller-1 os-net-config]# pwd
/etc/os-net-config
[root@overcloud-controller-1 os-net-config]# ls
config.json  dhcp_all_interfaces.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>We stop the collect service, so it doesn&#8217;t interfere with the manual execution</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-1 os-net-config]# systemctl stop os-collect-config.service
rvicemctl stop os-collect-config.se</pre>
</div>
</div>
<div class="paragraph">
<p>I created another filed called config.json and remvoved the eth3 configuration and run the os-net-config command, and all works fine</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-1 os-net-config]# os-net-config -c /etc/os-net-config/config.json.test -v --detailed-exit-codes
/config.json.test -v --detailed-exit-codes
[2017/06/13 03:37:27 PM] [INFO] Using config file at: /etc/os-net-config/config.json.test
[2017/06/13 03:37:27 PM] [INFO] Using mapping file at: /etc/os-net-config/mapping.yaml
[2017/06/13 03:37:27 PM] [INFO] Ifcfg net config provider created.
[2017/06/13 03:37:27 PM] [INFO] nic2 mapped to: eth7
[2017/06/13 03:37:27 PM] [INFO] nic1 mapped to: eth3
[2017/06/13 03:37:27 PM] [INFO] adding linux bond: bond0
[2017/06/13 03:37:27 PM] [INFO] adding custom route for interface: bond0
[2017/06/13 03:37:27 PM] [INFO] adding interface: eth0
[2017/06/13 03:37:27 PM] [INFO] adding interface: eth1
[2017/06/13 03:37:27 PM] [INFO] adding bridge: br-tenant
[2017/06/13 03:37:27 PM] [INFO] adding interface: eth2
[2017/06/13 03:37:27 PM] [INFO] adding vlan: vlan300
[2017/06/13 03:37:27 PM] [INFO] adding bridge: br-api
[2017/06/13 03:37:27 PM] [INFO] adding linux bond: bond2
[2017/06/13 03:37:27 PM] [INFO] adding interface: eth4
[2017/06/13 03:37:27 PM] [INFO] adding interface: eth5
[2017/06/13 03:37:27 PM] [INFO] adding vlan: vlan200
[2017/06/13 03:37:27 PM] [INFO] adding bridge: br-storage
[2017/06/13 03:37:27 PM] [INFO] adding linux bond: bond3
[2017/06/13 03:37:27 PM] [INFO] adding interface: eth6
[2017/06/13 03:37:27 PM] [INFO] adding interface: eth7
[2017/06/13 03:37:27 PM] [INFO] adding vlan: vlan100
[2017/06/13 03:37:27 PM] [INFO] applying network configs...
[2017/06/13 03:37:31 PM] [INFO] running ifup on bridge: br-tenant
[2017/06/13 03:37:31 PM] [INFO] running ifup on bridge: br-storage
[2017/06/13 03:37:32 PM] [INFO] running ifup on bridge: br-api
[2017/06/13 03:37:32 PM] [INFO] running ifup on interface: eth7
[2017/06/13 03:37:32 PM] [INFO] running ifup on interface: eth6
[2017/06/13 03:37:32 PM] [INFO] running ifup on interface: eth5
[2017/06/13 03:37:32 PM] [INFO] running ifup on interface: eth4
[2017/06/13 03:37:32 PM] [INFO] running ifup on interface: eth2
[2017/06/13 03:37:33 PM] [INFO] running ifup on interface: eth1
[2017/06/13 03:37:33 PM] [INFO] running ifup on interface: eth0
[2017/06/13 03:37:33 PM] [INFO] running ifup on interface: vlan300
[2017/06/13 03:37:38 PM] [INFO] running ifup on interface: vlan100
[2017/06/13 03:37:42 PM] [INFO] running ifup on interface: bond3
[2017/06/13 03:37:43 PM] [INFO] running ifup on interface: vlan200
[2017/06/13 03:37:47 PM] [INFO] running ifup on interface: bond2
[2017/06/13 03:37:48 PM] [INFO] running ifup on interface: eth1
[2017/06/13 03:37:48 PM] [INFO] running ifup on interface: eth0
[2017/06/13 03:37:48 PM] [INFO] running ifup on interface: eth5
[2017/06/13 03:37:48 PM] [INFO] running ifup on interface: eth4
[2017/06/13 03:37:48 PM] [INFO] running ifup on interface: eth7
[2017/06/13 03:37:48 PM] [INFO] running ifup on interface: eth6
[2017/06/13 03:37:48 PM] [INFO] running ifup on interface: bond0
[2017/06/13 03:37:53 PM] [INFO] running ifup on interface: bond2
[2017/06/13 03:37:53 PM] [INFO] running ifup on interface: bond3
[2017/06/13 03:37:54 PM] [INFO] running ifup on interface: vlan200
[2017/06/13 03:37:54 PM] [INFO] running ifup on interface: vlan300
[2017/06/13 03:37:55 PM] [INFO] running ifup on interface: vlan100</pre>
</div>
</div>
<div class="paragraph">
<p>After checking the controller nic-config templates, there was and identation error in the controller.yml file, with the vlan line in eth3 configuration, once the files where modified and the stack rerun the installation continued ok.</p>
</div>
<div class="paragraph">
<p><strong>Checking info in /var/lib/heat-config</strong></p>
</div>
<div class="paragraph">
<p>One dir that has a lot of deploy information is /var/lib/heat-config</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-0 ~]# ls /var/lib/heat-config
deployed  heat-config-puppet  heat-config-script</pre>
</div>
</div>
<div class="paragraph">
<p>The deployed dir has all the software deployment json files and the values returned to heat , there are 2 tipes of files, the normal .json  file that has the software configuration deployment info and the notify.json files that have the information that is sent back to heat once the software configuration is run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-0 ~]# ls /var/lib/heat-config/deployed/
0a79cff6-4a38-4c5a-9fa3-f1616e8b149c.json         a8b511c6-1674-4591-b0be-10635a461b5d.json         d46a530b-7b16-4948-bc2f-6b28774af5d8.json         f5cf6214-ad7a-474f-a1a2-b8bb46928447.json
0a79cff6-4a38-4c5a-9fa3-f1616e8b149c.notify.json  a8b511c6-1674-4591-b0be-10635a461b5d.notify.json  d46a530b-7b16-4948-bc2f-6b28774af5d8.notify.json  f6ab440a-2ba5-461e-8d88-3b11ec51c68c.json
13fa3272-df78-4496-8cee-0d31205697d5.json         b346901b-2da7-48a4-b71a-46efa69cc40c.json         e5107f50-dc0c-4235-b01c-02a97408f570.json         f6ab440a-2ba5-461e-8d88-3b11ec51c68c.notify.json
13fa3272-df78-4496-8cee-0d31205697d5.notify.json  b346901b-2da7-48a4-b71a-46efa69cc40c.notify.json  e5107f50-dc0c-4235-b01c-02a97408f570.notify.json</pre>
</div>
</div>
<div class="paragraph">
<p>Here is and example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@overcloud-controller-0 deployed]# cat a8b511c6-1674-4591-b0be-10635a461b5d.json | grep config
  "config": "#!/bin/bash\nset -e\n\nfunction ping_retry() {\n  local IP_ADDR=$1\n  local TIMES=${2:-'10'}\n  local COUNT=0\n  local PING_CMD=ping\n  if [[ $IP_ADDR =~ \":\" ]]; then\n    PING_CMD=ping6\n  fi\n  until [ $COUNT -ge $TIMES ]; do\n    if $PING_CMD -w 300 -c 1 $IP_ADDR &amp;&gt; /dev/null; then\n      echo \"Ping to $IP_ADDR succeeded.\"\n      return 0\n    fi\n    echo \"Ping to $IP_ADDR failed. Retrying...\"\n    COUNT=$(($COUNT + 1))\n  done\n  return 1\n}\n\n# For each unique remote IP (specified via Heat) we check to\n# see if one of the locally configured networks matches and if so we\n# attempt a ping test the remote network IP.\nfunction ping_controller_ips() {\n  local REMOTE_IPS=$1\n  for REMOTE_IP in $(echo $REMOTE_IPS | sed -e \"s| |\\n|g\" | sort -u); do\n    if [[ $REMOTE_IP =~ \":\" ]]; then\n      networks=$(ip -6 r | grep -v default | cut -d \" \" -f 1 | grep -v \"unreachable\")\n    else\n      networks=$(ip r | grep -v default | cut -d \" \" -f 1)\n    fi\n    for LOCAL_NETWORK in $networks; do\n      in_network=$(python -c \"import ipaddr; net=ipaddr.IPNetwork('$LOCAL_NETWORK'); addr=ipaddr.IPAddress('$REMOTE_IP'); print(addr in net)\")\n      if [[ $in_network == \"True\" ]]; then\n        echo \"Trying to ping $REMOTE_IP for local network ${LOCAL_NETWORK}.\"\n        set +e\n        if ! ping_retry $REMOTE_IP; then\n          echo \"FAILURE\"\n          echo \"$REMOTE_IP is not pingable. Local Network: $LOCAL_NETWORK\" &gt;&amp;2\n          exit 1\n        fi\n        set -e\n        echo \"SUCCESS\"\n      fi\n    done\n  done\n}\n\n# Ping all default gateways. There should only be one\n# if using upstream t-h-t network templates but we test\n# all of them should some manual network config have\n# multiple gateways.\nfunction ping_default_gateways() {\n  DEFAULT_GW=$(ip r | grep ^default | cut -d \" \" -f 3)\n  set +e\n  for GW in $DEFAULT_GW; do\n    echo -n \"Trying to ping default gateway ${GW}...\"\n    if ! ping_retry $GW; then\n      echo \"FAILURE\"\n      echo \"$GW is not pingable.\"\n      exit 1\n    fi\n  done\n  set -e\n  echo \"SUCCESS\"\n}\n\nping_controller_ips \"$ping_test_ips\"\nping_default_gateways\n",
[root@overcloud-controller-0 deployed]# cat a8b511c6-1674-4591-b0be-10635a461b5d.notify.json
{
  "deploy_stdout": "Trying to ping 10.0.0.58 for local network 10.0.0.0/24.\nPing to 10.0.0.58 succeeded.\nSUCCESS\nTrying to ping 192.168.101.150 for local network 192.168.101.0/24.\nPing to 192.168.101.150 succeeded.\nSUCCESS\nTrying to ping 192.168.1.151 for local network 192.168.1.0/24.\nPing to 192.168.1.151 succeeded.\nSUCCESS\nTrying to ping 192.168.2.152 for local network 192.168.2.0/24.\nPing to 192.168.2.152 succeeded.\nSUCCESS\nTrying to ping 192.168.3.161 for local network 192.168.3.0/24.\nPing to 192.168.3.161 succeeded.\nSUCCESS\nTrying to ping default gateway 192.168.101.1...Ping to 192.168.101.1 succeeded.\nSUCCESS\n",
  "deploy_stderr": "",
  "deploy_status_code": 0</pre>
</div>
</div>
<div class="paragraph">
<p>We can also check with the UUID the info of the software config on heat:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [stack@undercloud ~]$ heat config-list | grep -i a8b511c6-1674-4591-b0be-10635a461b5d
WARNING (shell) "heat config-list" is deprecated, please use "openstack software config list" instead
| a8b511c6-1674-4591-b0be-10635a461b5d | ControllerAllNodesValidationDeployment                                                                                            | script          | 2017-06-15T13:55:32Z |
[stack@undercloud ~]$ heat config-show a8b511c6-1674-4591-b0be-10635a461b5d
WARNING (shell) "heat config-show" is deprecated, please use "openstack software config show" instead
{
  "inputs": [
    {
      "default": "192.168.101.150 192.168.2.152 192.168.4.161 192.168.1.151 192.168.3.161 10.0.0.58",
      "type": "String",
      "name": "ping_test_ips",
      "value": "192.168.101.150 192.168.2.152 192.168.4.161 192.168.1.151 192.168.3.161 10.0.0.58",
      "description": ""
    },</pre>
</div>
</div>
<div class="paragraph">
<p><strong>os-collect-config</strong></p>
</div>
<div class="paragraph">
<p>This is a tool that starts at boot time, and continues to run via systemd. It’s primary responsibility is to monitor and download metadata from the Heat API. If the data has changed, it automatically calls os-refresh-config.
Its configured at boot time by cloud-init that populates /etc/os-collect-config.conf with credentials and the metadata url of the undercloud.</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@ctrl02 ~]# cat /etc/os-collect-config.conf
 [DEFAULT]
command = os-refresh-config --timeout 14400
collectors = ec2
collectors = request
collectors = local
 [request]
metadata_url = http://10.0.0.10:8080/v1/AUTH_e6128b61cf7a4169a8f61cdf41a27344/ov-74kpxh4ucep-1-4sgqxt3uvuen-Controller-upu7hcpbqzlx/d5c2ea57-1c1c-4366-82f8-01acdded95e7?temp_url_sig=f64f4ea5483aca3caff9e3cf6a7ce2539cf352ef&amp;temp_url_expires=2147483586</pre>
</div>
</div>
<div class="paragraph">
<p><strong>os-refresh-config</strong></p>
</div>
<div class="paragraph">
<p>os-collet-config calls another tool call os-refresh-config, among them you can see os-net-config, os-refresh-config doesn&#8217;t have a way to signal errors to heat, thats why failures like the ones in the network config don&#8217;t get reported back to heat, and you will have to wait for a timeout</p>
</div>
<div class="paragraph">
<p>The important steps that os-refresh-config take are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Apply systemctl configurables</p>
</li>
<li>
<p>Run os-apply-config (see below)</p>
</li>
<li>
<p>Configure the networking for the host</p>
</li>
<li>
<p>Download and set the hieradata files for puppet parameters</p>
</li>
<li>
<p>Configure /etc/hosts</p>
</li>
<li>
<p>Deploy software configuration with Heat</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is within these scripts that the metadata downloaded by os-collect-config will be acted upon, these are this scripts that run</p>
</div>
<div class="literalblock">
<div class="content">
<pre> [root@ctrl01 ~]# ls -l /usr/libexec/os-refresh-config/configure.d/
total 32
-rwxr-xr-x. 1 root root   42 May  4 12:13 20-os-apply-config
-rwxr-xr-x. 1 root root 3547 May  4 12:13 20-os-net-config
-rwxr-xr-x. 1 root root  629 May  4 12:13 25-set-network-gateway
-rwxr-xr-x. 1 root root 2830 May  4 12:13 40-hiera-datafiles
-rwxr-xr-x. 1 root root  394 May  4 12:13 40-truncate-nova-config
-rwxr-xr-x. 1 root root 1387 May  4 12:13 51-hosts
-rwxr-xr-x. 1 root root 6575 Sep  8  2016 55-heat-config</pre>
</div>
</div>
<div class="paragraph">
<p>If needed you can run the scripts by hand to get the output on screen for debugging purpouses.
Heat seeds the SoftwareDeployment to the nodes in the form of metadata, and relies on os-collect-config to download it, and os-refresh-config to apply it.</p>
</div>
<div class="paragraph">
<p><strong>Checking puppet in the overcloud nodes</strong></p>
</div>
<div class="paragraph">
<p>The hieradata files are populated from metadata in heat by the 40-hiera-datafiles script that is run by os-refresh-config, it dumps thehieradata info in /etc/puppet/hieradata, it can be very usefull to check variable data in this dir, so for example we are wondering were this ip came from</p>
</div>
<div class="paragraph">
<p><code>[root@ctrl01 hieradata]# pcs status | grep 192.168.2.190
ip-192.168.2.190       (ocf::heartbeat:IPaddr2):       Started ctrl01</code></p>
</div>
<div class="paragraph">
<p>We can check in the hieradata files</p>
</div>
<div class="literalblock">
<div class="content">
<pre> root@ctrl01 hieradata]# grep 192.168.2.190 /etc/puppet/hieradata/vip_data.yaml
redis_vip: 192.168.2.190
tripleo::keepalived::redis_virtual_ip: 192.168.2.190</pre>
</div>
</div>
<div class="paragraph">
<p>Also service conf files variables, for example the endpoint on this host for the tenant vxlan tunnel</p>
</div>
<div class="literalblock">
<div class="content">
<pre> root@ctrl01 hieradata]# grep local_ip /etc/puppet/hieradata/service_configs.yaml
neutron::agents::ml2::ovs::local_ip: 192.168.3.150</pre>
</div>
</div>
<div class="paragraph">
<p>Puppet code is run from dir "", if puppet is getting at some point we can kill the puppet process and run it by hand</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-06-17 01:02:52 CEST
</div>
</div>
</body>
</html>